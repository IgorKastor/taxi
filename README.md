#  Прогнозирование заказов такси
## Аннотация
**Цель.** Спрогнозировать количество заказов такси на следующий час - построить модель для такого предсказания.

Требуемое значение метрики на тестовой выборке $RMSE\le48$.

**Данные.** Исторические данные о заказах такси в аэропортах:
- `datetime` - время, с интервалом 10 мин;
- `num_orders` - количество заказов в начале интервала (десятиминутки).

**Задачи:**

1. Загрузить данные и выполнить их ресемплирование по одному часу.
2. Проанализировать данные.
3. Обучить разные модели с различными гиперпараметрами (тестовая выборка - 10% от исходных данных).
4. Проверить данные на тестовой выборке и сделать выводы

## Результаты
### Предобработка данных 
В файле было 26+ тыс записей, без пропусков и дубликатов, о числе заказов такси за март-август 2018 г. с интервалами по 10 мин. В результате ресемплирования по 1 часу  получили 4,4 тыс записей:
- среднее число заказов в час - 84;
- медиана - 78;
- стандартное отклонение - 48.

Очевидно, число заказов сильно колеблется во времени.

### Разведочный анализ
Заметен тренд на увеличение заказов с начала лета и особенно в августе, что, разумеется, связано с сезоном отпусков. Заметна также "стохастическая" суточная цикличность. 

Недельный тренд распределения числа среднего числа заказов "цикличен" в течение всего рассматриваемого периода. Наибольшее среднее число заказов было в ПН и ПТ, наименьшее - во ВТ и ВС. В августе число заказов ежедневно на 20+% больше, чем в предыдущие месяцы, в частности, в ПН в августе заказов почти в 2 раза больше, чем в мае и июне.

В течение суток пики заказов приходится на 16.30-17.00 (возвращение с работы) и на полночь (возвращение из заведений), минимум - на 6 утра (большинство уже/еще спят). Наблюдается нечто вроде цикличности с 6-часовым периодом.

Наибольшие отклонения от стационарности характерны для конечного отрезка ряда (вторая половина августа). Одна из возможных причин - влияние графика отпусков и, соответственно, конкретных дат прилетов и отлетов. 

При исследовании разностей временного ряда обнаружено, что: 
1. Максимальные колебания на графике разности соседних дней по понедельникам сохранились. Суточное среднее разности более гладкое и незначительно колеблется около нуля. Профиль кривой стандартного отклонения разности мало отличается от кривой стандартного отклонения количества
2. Максимальные положительные колебания на графике разности одинаковых дат мая-августа по понедельникам сохранились, отрицательные сместились на середину недели. Суточное среднее разности почти превратилось в синусоиду. Профиль кривой стандартного отклонения разности сохранился, но период ступенчатых колебаний уменьшился в 2 раза.

Таким образом обнаружили либо некое фундаметнальное свойство данного временного ряда, либо (что вероятнее) синтетический характер данных.

### Выделение новых признаков
Новые признаки, в том чисоле лаги, создали на обучающей и тестовой выборках по отдельности - во избежание утечки данных. Для выделения контраста циклических тенденций добавили $24\cdot7=168$ временных лагов по числу часов в одной неделе.

Каждый лаг заметно коррелирует с соседними 2-3 лагами, а также с суточным средним, которое также умеренно коррелирует с числом заказов. 

День месяца, день недели и час заказа почти не коррелируют с числом заказов или между собой. Имеется необычная умеренная корреляция 19-20-го лагов с часом заказа (может быть, это связано с синтетическим характером данных).

Сильнее всего с числом заказов коррелирует 168-й лаг. Во избежание большого числа признаков и мультиколлинеарности для обучения использовали 168-й лаг и суточное среднее, т.к. они слабо коррелируют друг с другом, а также ранговые признаки (день месяца, день недели и час заказа) - они могли оказаться полезными для древесных моделей.

Отношение между тестовой и обучающей выборками уменьшилось после исключения пропусков, возникших после создания временных лагов (0,07 от всех данных вместо 0,1).  Для сохранения заданного отношения $9:1$ обрезали начало обучающей выборки на 56 дней. В итоге обучающая выборка охватывала промежуток времени с 3 мая по 13 августа (2462 записи), тестовая - с 20 по 31 августа (274 записи). Тестовая выборка получилась небольшой и охватывает самую "нестационарную" часть датасета (вторая половина августа), это не позволит сделать качество прогноза максимально высоким.

### Обучение прогностических моделей
При равной эффективности быстрее обычная линейная регрессия (без регуляризации) - при обучении $RMSE=25,7$, общее время подбора параметров и обучения $2$ сек. У модели *LightGBM* при обучении $RMSE=19,9$ и время работы более $300$ сек. Модель регрессии во много раз быстрее учится, но у модели *LightGBM* меньше метрика, поэтому на тестовой выборке проверили обе модели. 

Древесная модель с бустингом переобучилась и на тестировании едва влезла в ограничение $RMSE<48$, классическая регрессия показала лучший результат:
- линейная регрессия: $RMSE=37,9$;
- *LightGBM*: $RMSE=44,2$

Проверка на адекватность пройдена: у тривиального прогноза по предыдущему значению $RMSE=60,0$; у прогноза по среднему от обучения $RMSE=81,9$.

Значительные случайные колебания числа заказов в конце августа объясняют относительно низкое качество прогноза.